'use client'

import { useState, useEffect } from 'react'
import { useSearchParams } from 'next/navigation'
import { useAuth } from '@/contexts/AuthContext'
import { Button } from '@/components/shared/ui/button'
import { Input } from '@/components/shared/ui/input'
import { Label } from '@/components/shared/ui/label'
import { Textarea } from '@/components/shared/ui/textarea'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/shared/ui/select'
import { useToast } from '@/hooks/use-toast'
import { User, MapPin, Phone, Briefcase, FileText, Loader2, CheckCircle, X, Info, Sparkles, Camera, Edit, XCircle, Eye } from 'lucide-react'
import Image from 'next/image'
import Link from 'next/link'
import { uploadProfilePhoto, optimizeImage } from '@/lib/storage'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger
} from '@/components/shared/ui/tooltip'
import { cn, slugify } from '@/lib/utils'
import { calculateProfileCompletion, getCompletionColor } from '@/lib/profile-completion'

const WORK_STATUS_OPTIONS = [
  { value: 'employed', label: 'Employed' },
  { value: 'unemployed', label: 'Unemployed Looking for Work' },
  { value: 'freelancer', label: 'Freelancer' },
  { value: 'part_time', label: 'Part-time' },
  { value: 'student', label: 'Student' },
]

const MOOD_OPTIONS = [
  { value: 'happy', label: 'Happy' },
  { value: 'satisfied', label: 'Satisfied' },
  { value: 'neutral', label: 'Neutral' },
  { value: 'stressed', label: 'Stressed' },
  { value: 'motivated', label: 'Motivated' }
]

const SHIFT_OPTIONS = [
  { value: 'day', label: 'Day' },
  { value: 'night', label: 'Night' },
  { value: 'both', label: 'Both' }
]

const WORK_SETUP_OPTIONS = [
  { value: 'office', label: 'Work From Office' },
  { value: 'hybrid', label: 'Hybrid' },
  { value: 'remote', label: 'Work From Home' },
  { value: 'any', label: 'Any' }
]

export default function CandidateProfilePage() {
  const { user } = useAuth()
  const { toast } = useToast()
  const searchParams = useSearchParams()
  const isWelcome = searchParams?.get('welcome') === 'true'
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [isEditing, setIsEditing] = useState(false)
  const [profile, setProfile] = useState<any>(null)
  const [usernameChecking, setUsernameChecking] = useState(false)
  const [usernameAvailable, setUsernameAvailable] = useState<boolean | null>(null)
  const [usernameTimeout, setUsernameTimeout] = useState<NodeJS.Timeout | null>(null)
  const [age, setAge] = useState<number | null>(null)
  const [avatarUrl, setAvatarUrl] = useState<string | null>(null)
  const [photoUploading, setPhotoUploading] = useState(false)
  const [photoError, setPhotoError] = useState<string | null>(null)
  const [saveSuccess, setSaveSuccess] = useState(false)
  const [coverPhotoUrl, setCoverPhotoUrl] = useState<string | null>(null)
  const [coverPhotoUploading, setCoverPhotoUploading] = useState(false)
  const [coverPhotoError, setCoverPhotoError] = useState<string | null>(null)
  const [locationParsing, setLocationParsing] = useState(false)

  const [formData, setFormData] = useState({
    username: '',
    bio: '',
    headline: '',
    position: '',
    location: '',
    location_lat: null as number | null,
    location_lng: null as number | null,
    location_city: '',
    location_province: '',
    location_country: '',
    location_barangay: '',
    location_region: '',
    birthday: '',
    gender: '',
    gender_custom: '',
    phone: '',
    work_status: '',
    expected_salary_min: '',
    expected_salary_max: '',
    preferred_shift: '',
    preferred_work_setup: '',
    current_mood: '',
    cover_photo: '',
    website: '',
    linkedin: '',
    github: '',
    twitter: '',
    portfolio: '',
    facebook: '',
  })

  useEffect(() => {
    if (user) {
      fetchProfile()
    }
  }, [user])

  // Auto-enable editing if profile is incomplete
  useEffect(() => {
    if (profile && !profile.profile_completed) {
      setIsEditing(true)
    }
  }, [profile])

  // Calculate age when birthday changes
  useEffect(() => {
    if (formData.birthday) {
      const today = new Date()
      const birthDate = new Date(formData.birthday)
      let calculatedAge = today.getFullYear() - birthDate.getFullYear()
      const monthDiff = today.getMonth() - birthDate.getMonth()
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        calculatedAge--
      }
      
      setAge(calculatedAge)
    } else {
      setAge(null)
    }
  }, [formData.birthday])

  // Note: Removed auto-clearing of fields based on work status
  // Users can now fill in these fields regardless of work status

  async function fetchProfile() {
    if (!user?.id) {
      console.warn('‚ö†Ô∏è No user ID available for fetching profile')
      return
    }

    try {
      setLoading(true)
      console.log('üîÑ Fetching profile for user:', user.id)
      
      // Fetch candidate data including avatar_url
      const candidateRes = await fetch(`/api/candidates/${user.id}`)
      if (!candidateRes.ok) {
        throw new Error(`Failed to fetch candidate: ${candidateRes.status}`)
      }
      
      const { candidate, profile: candidateProfile } = await candidateRes.json()
      console.log('‚úÖ Fetched candidate:', { 
        id: candidate.id, 
        username: candidate.username, 
        avatar_url: candidate.avatar_url 
      })
      
      if (candidate.avatar_url) {
        setAvatarUrl(candidate.avatar_url)
      }

      // Set cover photo if exists
      if (candidateProfile?.cover_photo) {
        setCoverPhotoUrl(candidateProfile.cover_photo)
      }
      
      // Fetch profile directly from candidates API which uses admin client
      const profileRes = await fetch(`/api/candidates/${user.id}/profile`)
      let profileData = null
      if (profileRes.ok) {
        const profileResult = await profileRes.json()
        profileData = profileResult.profile
        console.log('‚úÖ Fetched profile:', { 
          id: profileData?.id, 
          work_status: profileData?.work_status,
          location: profileData?.location 
        })
      } else {
        console.warn('‚ö†Ô∏è Profile fetch failed, using candidate profile or defaults')
      }
      
      // Use profileData if available, otherwise use candidateProfile or empty defaults
      const userData = profileData || candidateProfile || {}
      
      // Set form data with proper defaults and type conversions
      setFormData({
        username: candidate.username || userData.username || '',
        bio: userData.bio || '',
        headline: userData.headline || '',
        position: userData.position || '',
        location: userData.location || '',
        location_lat: userData.location_lat || null,
        location_lng: userData.location_lng || null,
        location_city: userData.location_city || '',
        location_province: userData.location_province || '',
        location_country: userData.location_country || 'Philippines',
        location_barangay: userData.location_barangay || '',
        location_region: userData.location_region || '',
        birthday: userData.birthday || '',
        gender: userData.gender || '',
        gender_custom: userData.gender_custom || '',
        phone: userData.phone || '',
        work_status: userData.work_status || '',
        expected_salary_min: userData.expected_salary_min ? String(userData.expected_salary_min) : '',
        expected_salary_max: userData.expected_salary_max ? String(userData.expected_salary_max) : '',
        preferred_shift: userData.preferred_shift || '',
        preferred_work_setup: userData.preferred_work_setup || '',
        current_mood: userData.current_mood || 'prefer_not_to_say',
        cover_photo: userData.cover_photo || '',
        website: userData.website || '',
        linkedin: userData.linkedin || '',
        github: userData.github || '',
        twitter: userData.twitter || '',
        portfolio: userData.portfolio || '',
        facebook: userData.facebook || '',
      })
      
      // Also update profile state for other components
      if (profileData) {
        setProfile({
          ...candidate,
          ...profileData,
        })
      } else {
        setProfile(candidate)
      }
      
      console.log('‚úÖ Profile loaded successfully')
    } catch (error) {
      console.error('‚ùå Error fetching profile:', error)
      toast({
        title: 'Error',
        description: 'Failed to load profile. Please refresh the page.',
        variant: 'destructive',
      })
    } finally {
      setLoading(false)
    }
  }

  const checkUsernameAvailability = async (username: string) => {
    if (!username || username.length < 3) {
      setUsernameAvailable(null)
      return
    }

    setUsernameChecking(true)
    try {
      const response = await fetch('/api/user/check-username', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, userId: user?.id }),
      })

      const data = await response.json()
      
      if (response.ok) {
        setUsernameAvailable(data.available)
      } else {
        setUsernameAvailable(false)
      }
    } catch (error) {
      console.error('Error checking username:', error)
      setUsernameAvailable(false)
    } finally {
      setUsernameChecking(false)
    }
  }

  // Handle profile picture upload
  const handlePhotoUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (!file || !user) return

    try {
      setPhotoUploading(true)
      setPhotoError(null)

      console.log('üì∏ Starting photo upload...')

      // Validate file type
      if (!file.type.startsWith('image/')) {
        throw new Error('Please select an image file')
      }

      // Validate file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        throw new Error('File size must be less than 5MB')
      }

      // Optimize image
      const optimizedFile = await optimizeImage(file)
      console.log('‚úÖ Image optimized')

      // Upload to Supabase
      const { publicUrl } = await uploadProfilePhoto(optimizedFile, user.id)
      console.log('‚úÖ Photo uploaded to Supabase:', publicUrl)

      // Update candidate's avatar_url in Supabase via API route
      const response = await fetch(`/api/candidates/${user.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          avatar_url: publicUrl,
        }),
      })

      if (!response.ok) {
        const errorText = await response.text()
        console.error('‚ùå Failed to update avatar_url:', response.status, errorText)
        throw new Error('Failed to update profile photo')
      }

      // Update local state
      setAvatarUrl(publicUrl)
      console.log('‚úÖ Profile photo updated successfully, avatarUrl set to:', publicUrl)

      toast({
        title: 'Photo uploaded',
        description: 'Your profile photo has been updated successfully.',
      })

      // Trigger header update if needed
      window.dispatchEvent(new CustomEvent('profileUpdated'))
      
      // Refresh profile to ensure everything is in sync
      setTimeout(() => {
        fetchProfile()
      }, 500)

    } catch (error) {
      console.error('‚ùå Photo upload failed:', error)
      const errorMessage = error instanceof Error ? error.message : 'Failed to upload photo'
      setPhotoError(errorMessage)
      toast({
        title: 'Upload failed',
        description: errorMessage,
        variant: 'destructive',
      })
    } finally {
      setPhotoUploading(false)
      // Reset file input
      if (event.target) {
        event.target.value = ''
      }
    }
  }

  // Handle cover photo upload
  const handleCoverPhotoUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (!file || !user) return

    try {
      setCoverPhotoUploading(true)
      setCoverPhotoError(null)

      console.log('üñºÔ∏è Starting cover photo upload...')

      // Validate file type
      if (!file.type.startsWith('image/')) {
        throw new Error('Please select an image file')
      }

      // Validate file size (10MB limit for cover photos)
      if (file.size > 10 * 1024 * 1024) {
        throw new Error('File size must be less than 10MB')
      }

      // Optimize image (cover photos are larger: 1200x400)
      const optimizedFile = await optimizeImage(file, 1200, 400, 0.85)
      console.log('‚úÖ Cover photo optimized')

      // Upload to Supabase with 'cover' type
      const { publicUrl } = await uploadProfilePhoto(optimizedFile, user.id, 'cover')
      console.log('‚úÖ Cover photo uploaded to Supabase:', publicUrl)

      // Update profile's cover_photo in Supabase via API route
      const response = await fetch(`/api/candidates/${user.id}/profile`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          cover_photo: publicUrl,
        }),
      })

      if (!response.ok) {
        const errorText = await response.text()
        console.error('‚ùå Failed to update cover photo:', response.status, errorText)
        throw new Error('Failed to update cover photo')
      }

      // Update local state
      setCoverPhotoUrl(publicUrl)
      setFormData(prev => ({ ...prev, cover_photo: publicUrl }))
      console.log('‚úÖ Cover photo updated successfully:', publicUrl)

      toast({
        title: 'Cover photo uploaded',
        description: 'Your cover photo has been updated successfully.',
      })

      // Refresh profile to ensure everything is in sync
      setTimeout(() => {
        fetchProfile()
      }, 500)

    } catch (error) {
      console.error('‚ùå Cover photo upload failed:', error)
      const errorMessage = error instanceof Error ? error.message : 'Failed to upload cover photo'
      setCoverPhotoError(errorMessage)
      toast({
        title: 'Upload failed',
        description: errorMessage,
        variant: 'destructive',
      })
    } finally {
      setCoverPhotoUploading(false)
      // Reset file input
      if (event.target) {
        event.target.value = ''
      }
    }
  }

  const handleInputChange = (field: string, value: any) => {
    setFormData(prev => ({ ...prev, [field]: value }))

    if (field === 'username') {
      if (usernameTimeout) {
        clearTimeout(usernameTimeout)
      }
      const timeoutId = setTimeout(() => {
        checkUsernameAvailability(value)
      }, 500)
      setUsernameTimeout(timeoutId)
    }

    if (field === 'gender' && value !== 'other') {
      setFormData(prev => ({ ...prev, gender_custom: '' }))
    }
  }

  // AI-powered location parser using Claude Haiku
  const parseLocation = async (locationText: string) => {
    if (!locationText || locationText.trim().length < 3) {
      return
    }

    // Skip if already parsing
    if (locationParsing) {
      return
    }

    try {
      setLocationParsing(true)
      console.log('ü§ñ Parsing location with AI:', locationText)

      const response = await fetch('/api/parse-location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location: locationText }),
      })

      if (!response.ok) {
        throw new Error('Failed to parse location')
      }

      const result = await response.json()

      if (result.success && result.data) {
        console.log('‚úÖ AI parsed location:', result.data)

        // Auto-fill the hidden fields
        setFormData(prev => ({
          ...prev,
          location_city: result.data.city || prev.location_city,
          location_province: result.data.province || prev.location_province,
          location_country: result.data.country || 'Philippines',
          location_region: result.data.region || prev.location_region,
          location_barangay: result.data.barangay || prev.location_barangay,
          location_lat: result.data.lat || prev.location_lat,
          location_lng: result.data.lng || prev.location_lng,
        }))

        const coords = result.data.lat && result.data.lng ? ` (${result.data.lat.toFixed(4)}, ${result.data.lng.toFixed(4)})` : ''
        toast({
          title: 'Location parsed',
          description: `Detected: ${result.data.city || ''} ${result.data.province || ''}${coords}`.trim(),
        })
      }
    } catch (error) {
      console.error('‚ùå Location parsing failed:', error)
      // Silently fail - don't annoy user with error toast
    } finally {
      setLocationParsing(false)
    }
  }

  async function handleSave() {
    // Prevent double-click
    if (saving) {
      console.log('‚ö†Ô∏è Save already in progress, ignoring...')
      return
    }
    
    try {
      setSaving(true)
      setSaveSuccess(false)
      
      // Collect all validation errors at once
      const missingFields: string[] = []
      
      if (!formData.location || formData.location.trim() === '') missingFields.push('Location')
      if (!formData.birthday || formData.birthday.trim() === '') missingFields.push('Birthday')
      if (!formData.work_status || formData.work_status.trim() === '') missingFields.push('Work Status')
      if (!formData.expected_salary_min || !formData.expected_salary_max) missingFields.push('Expected Salary Range')
      if (!formData.preferred_shift || formData.preferred_shift.trim() === '') missingFields.push('Preferred Shift')
      if (!formData.preferred_work_setup || formData.preferred_work_setup.trim() === '') missingFields.push('Preferred Work Setup')
      
      if (missingFields.length > 0) {
        toast({
          title: 'Please complete required fields',
          description: missingFields.join(', '),
          variant: 'destructive',
        })
        setSaving(false)
        return
      }
      
      // Prepare candidate update (username, slug only - phone moved to profile)
      const candidateUpdate: any = {}
      if (formData.username && formData.username.trim()) {
        const usernameLower = formData.username.toLowerCase().trim()
        candidateUpdate.username = usernameLower
        // Generate slug from username
        candidateUpdate.slug = slugify(usernameLower)
      }

      // Prepare profile update with proper data types
      const profileUpdate: any = {
        // Personal info
        bio: formData.bio?.trim() || null,
        headline: formData.headline?.trim() || null,
        phone: formData.phone?.trim() || null,
        birthday: formData.birthday?.trim() || null,
        gender: formData.gender || null,
        gender_custom: formData.gender === 'other' ? (formData.gender_custom?.trim() || null) : null,

        // Location (Philippines-focused)
        location: formData.location?.trim() || null,
        location_lat: formData.location_lat ? parseFloat(String(formData.location_lat)) : null,
        location_lng: formData.location_lng ? parseFloat(String(formData.location_lng)) : null,
        location_city: formData.location_city?.trim() || null,
        location_province: formData.location_province?.trim() || null,
        location_country: formData.location_country?.trim() || 'Philippines',
        location_barangay: formData.location_barangay?.trim() || null,
        location_region: formData.location_region?.trim() || null,

        // Career preferences
        position: formData.position?.trim() || null,
        work_status: formData.work_status || null,
        preferred_shift: formData.preferred_shift || null,
        preferred_work_setup: formData.preferred_work_setup || null,
        expected_salary_min: formData.expected_salary_min && formData.expected_salary_min.trim() ? parseFloat(formData.expected_salary_min) : null,
        expected_salary_max: formData.expected_salary_max && formData.expected_salary_max.trim() ? parseFloat(formData.expected_salary_max) : null,
        current_mood: formData.current_mood === 'prefer_not_to_say' || !formData.current_mood ? null : formData.current_mood,

        // Social links
        website: formData.website?.trim() || null,
        linkedin: formData.linkedin?.trim() || null,
        github: formData.github?.trim() || null,
        twitter: formData.twitter?.trim() || null,
        portfolio: formData.portfolio?.trim() || null,
        facebook: formData.facebook?.trim() || null,

        // Photos
        cover_photo: coverPhotoUrl || formData.cover_photo || null,

        // Completion flag
        profile_completed: true,
      }
      
      console.log('üíæ Saving profile:', {
        candidateUpdate,
        profileUpdate: {
          bio: profileUpdate.bio,
          position: profileUpdate.position,
          location: profileUpdate.location,
          birthday: profileUpdate.birthday,
          gender: profileUpdate.gender,
          profile_completed: profileUpdate.profile_completed, // THIS IS THE KEY FLAG
        }
      })
      
      // Update candidate (username, phone, slug) - do this first
      if (Object.keys(candidateUpdate).length > 0) {
        const candidateResponse = await fetch(`/api/candidates/${user?.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(candidateUpdate),
        })
        
        if (!candidateResponse.ok) {
          const errorData = await candidateResponse.json().catch(() => ({}))
          console.error('‚ùå Candidate update failed:', errorData)
          throw new Error(errorData.details || errorData.error || 'Failed to update candidate')
        }
      }
      
      // Update profile - do this second
      const profileResponse = await fetch(`/api/candidates/${user?.id}/profile`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(profileUpdate),
      })

      if (!profileResponse.ok) {
        const errorData = await profileResponse.json().catch(() => ({}))
        console.error('‚ùå Profile update failed:', errorData)
        throw new Error(errorData.details || errorData.error || 'Failed to update profile')
      }

      const profileResult = await profileResponse.json()
      console.log('‚úÖ Profile saved successfully:', profileResult)
      
      // Show success state
      setSaveSuccess(true)
      setIsEditing(false)
      
      // Reload profile data in background
      fetchProfile().catch(err => {
        console.error('‚ö†Ô∏è Error reloading profile after save:', err)
      })

      // Notify sidebar to refetch completion data
      window.dispatchEvent(new CustomEvent('profileUpdated'))

      toast({
        title: '‚úÖ Profile Saved!',
        description: 'Your changes have been saved successfully.',
      })

      // Reset success state after 3 seconds
      setTimeout(() => setSaveSuccess(false), 3000)
      
    } catch (error) {
      console.error('‚ùå Error saving profile:', error)
      const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred'
      toast({
        title: 'Save Failed',
        description: errorMessage,
        variant: 'destructive',
      })
    } finally {
      setSaving(false)
    }
  }

  const handleEdit = () => {
    setIsEditing(true)
  }

  const handleCancel = () => {
    setIsEditing(false)
    // Reload profile to reset any unsaved changes
    fetchProfile()
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto"></div>
          <p className="mt-4 text-gray-400">Loading Profile...</p>
        </div>
      </div>
    )
  }

  const inputClass = "bg-white/5 border-white/10 text-white placeholder:text-gray-500 focus:border-cyan-500/50 focus:ring-cyan-500/20 transition-all"
  const labelClass = "text-gray-300"
  const isProfileCompleted = profile?.profile_completed || false
  const shouldDisableFields = !isEditing && isProfileCompleted

  // Calculate real-time profile completion based on current form data
  const realTimeCompletion = calculateProfileCompletion(
    {
      first_name: user?.user_metadata?.first_name || profile?.first_name,
      last_name: user?.user_metadata?.last_name || profile?.last_name,
      avatar_url: avatarUrl || profile?.avatar_url,
    },
    {
      phone: formData.phone,
      location: formData.location,
      cover_photo: formData.cover_photo || coverPhotoUrl,
      bio: formData.bio,
      position: formData.position,
      work_status: formData.work_status,
      preferred_shift: formData.preferred_shift,
      preferred_work_setup: formData.preferred_work_setup,
      expected_salary_min: formData.expected_salary_min,
      expected_salary_max: formData.expected_salary_max,
      birthday: formData.birthday,
      gender: formData.gender,
    }
  )

  const completionColors = getCompletionColor(realTimeCompletion.percentage)

  return (
    <TooltipProvider>
      <div className="space-y-6 pb-8">
        {/* Enhanced Success Overlay with Spinning Animation */}
        {saveSuccess && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-md animate-in fade-in duration-300">
            <div className="relative bg-gradient-to-br from-emerald-500/10 via-cyan-500/10 to-purple-500/10 border border-emerald-400/30 rounded-3xl p-10 text-center animate-in zoom-in-95 duration-500 shadow-2xl shadow-emerald-500/20 max-w-md">
              {/* Animated rings */}
              <div className="absolute inset-0 rounded-3xl bg-gradient-to-br from-emerald-500/5 to-cyan-500/5 animate-pulse" />

              {/* Success Icon with Pulse */}
              <div className="relative w-20 h-20 mx-auto mb-6">
                <div className="absolute inset-0 rounded-full bg-gradient-to-br from-emerald-500/30 to-cyan-500/30 animate-ping" />
                <div className="relative w-20 h-20 rounded-full bg-gradient-to-br from-emerald-500/20 to-cyan-500/20 flex items-center justify-center border border-emerald-400/40">
                  <CheckCircle className="w-12 h-12 text-emerald-400 drop-shadow-lg animate-in zoom-in duration-700" />
                </div>
              </div>

              <h3 className="text-2xl font-bold text-white mb-2">Profile Saved!</h3>
              <p className="text-gray-300 text-sm">Your information has been updated successfully</p>
            </div>
          </div>
        )}

        {/* Completion Banner - Gradient Style */}
        {!isProfileCompleted && (
          <div className="relative overflow-hidden rounded-xl border border-amber-400/30 bg-gradient-to-r from-amber-500/10 via-orange-500/10 to-amber-500/10 backdrop-blur-sm">
            <div className="absolute inset-0 bg-gradient-to-r from-amber-500/5 to-orange-500/5" />
            <div className="relative p-4 flex items-center gap-4">
              <div className="flex-shrink-0 w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center border border-amber-400/30">
                <Info className="w-5 h-5 text-amber-400" />
              </div>
              <div className="flex-1">
                <p className="text-sm font-semibold text-amber-100">Complete your profile to stand out</p>
                <p className="text-xs text-amber-200/70 mt-0.5">Recruiters are 3x more likely to contact candidates with complete profiles</p>
              </div>
            </div>
          </div>
        )}

        {/* REAL-TIME PROFILE COMPLETION PROGRESS BAR */}
        <div className={cn(
          "relative overflow-hidden rounded-xl border backdrop-blur-sm transition-all duration-500",
          completionColors.border,
          completionColors.bg
        )}>
          <div className="relative p-6">
            {/* Progress Header */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className={cn(
                  "w-12 h-12 rounded-full flex items-center justify-center border-2 font-bold text-lg transition-all duration-500",
                  completionColors.border,
                  completionColors.text
                )}>
                  {realTimeCompletion.percentage}%
                </div>
                <div>
                  <h3 className={cn("text-lg font-bold transition-colors duration-500", completionColors.text)}>
                    Profile Completion
                  </h3>
                  <p className="text-xs text-gray-400">
                    {realTimeCompletion.completedFields} of {realTimeCompletion.totalFields} fields completed
                  </p>
                </div>
              </div>
              {realTimeCompletion.percentage === 100 && (
                <CheckCircle className={cn("w-8 h-8 animate-in zoom-in duration-500", completionColors.text)} />
              )}
            </div>

            {/* Animated Progress Bar */}
            <div className="relative w-full h-3 bg-white/5 rounded-full overflow-hidden border border-white/10">
              <div
                className={cn(
                  "absolute inset-y-0 left-0 rounded-full transition-all duration-700 ease-out",
                  realTimeCompletion.percentage < 25 ? "bg-gradient-to-r from-red-500 to-red-600" :
                  realTimeCompletion.percentage < 50 ? "bg-gradient-to-r from-orange-500 to-orange-600" :
                  realTimeCompletion.percentage < 75 ? "bg-gradient-to-r from-yellow-500 to-yellow-600" :
                  realTimeCompletion.percentage < 100 ? "bg-gradient-to-r from-cyan-500 to-cyan-600" :
                  "bg-gradient-to-r from-green-500 to-green-600"
                )}
                style={{ width: `${realTimeCompletion.percentage}%` }}
              >
                <div className="absolute inset-0 bg-white/20 animate-pulse" />
              </div>
            </div>

            {/* Encouraging Message */}
            {realTimeCompletion.percentage < 100 && (
              <div className="mt-4 flex items-start gap-2">
                <Sparkles className={cn("w-4 h-4 mt-0.5 flex-shrink-0", completionColors.text)} />
                <div>
                  <p className="text-sm text-gray-300">{realTimeCompletion.encouragingMessage}</p>
                  <p className="text-xs text-gray-500 mt-1">Next: {realTimeCompletion.nextStep}</p>
                </div>
              </div>
            )}

            {/* Missing Fields (only show if < 100%) */}
            {realTimeCompletion.percentage < 100 && realTimeCompletion.missingFields.length > 0 && (
              <details className="mt-4 text-xs">
                <summary className="cursor-pointer text-gray-400 hover:text-gray-300 transition-colors">
                  Show missing fields ({realTimeCompletion.missingFields.length})
                </summary>
                <ul className="mt-2 space-y-1 text-gray-500 pl-4">
                  {realTimeCompletion.missingFields.map((field, idx) => (
                    <li key={idx} className="list-disc">{field}</li>
                  ))}
                </ul>
              </details>
            )}
          </div>
        </div>

        {/* Header Section with Gradient Underline */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b border-white/5">
          <div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-white via-cyan-100 to-purple-100 bg-clip-text text-transparent">
              {isEditing ? 'Edit Profile' : 'Your Profile'}
            </h1>
            <p className="text-gray-400 mt-2 text-sm">
              {isEditing
                ? 'Update your professional information'
                : 'Manage your profile and career preferences'}
            </p>
          </div>
          <div className="flex gap-2 flex-shrink-0">
            {isEditing ? (
              <>
                <Button
                  onClick={handleCancel}
                  disabled={saving}
                  variant="outline"
                  className="border-white/10 text-gray-300 hover:bg-white/5 hover:border-white/20 transition-all"
                >
                  <X className="w-4 h-4 mr-2" />
                  Cancel
                </Button>
                <Button
                  onClick={handleSave}
                  disabled={saving}
                  className="bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-600 hover:to-purple-700 text-white shadow-lg shadow-cyan-500/25 transition-all duration-300 hover:scale-105"
                >
                  {saving ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Saving...
                    </>
                  ) : (
                    <>
                      <CheckCircle className="w-4 h-4 mr-2" />
                      Save Changes
                    </>
                  )}
                </Button>
              </>
            ) : (
              <>
                <Link href={`/${profile?.slug || 'profile'}`}>
                  <Button
                    variant="outline"
                    className="border-purple-500/30 text-purple-400 hover:bg-purple-500/10 hover:border-purple-400/50 transition-all"
                  >
                    <Eye className="w-4 h-4 mr-2" />
                    View Public
                  </Button>
                </Link>
                <Button
                  onClick={handleEdit}
                  className="bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-600 hover:to-purple-700 text-white shadow-lg shadow-cyan-500/25 transition-all duration-300 hover:scale-105"
                >
                  <Edit className="w-4 h-4 mr-2" />
                  Edit Profile
                </Button>
              </>
            )}
          </div>
        </div>

        {/* Cover Photo + Profile Photo Section - Enhanced */}
        <div className="relative rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl overflow-hidden transition-all duration-300 hover:border-white/20 hover:shadow-2xl hover:shadow-purple-500/10 group">
          {/* Cover Photo with Gradient Overlay */}
          <div className="relative h-56 bg-gradient-to-br from-cyan-900/40 via-purple-900/40 to-blue-900/40">
            {coverPhotoUrl ? (
              <>
                <Image
                  src={coverPhotoUrl}
                  alt="Cover Photo"
                  fill
                  className="object-cover"
                  unoptimized
                  onError={() => setCoverPhotoUrl(null)}
                />
                <div className="absolute inset-0 bg-gradient-to-t from-[#0B0B0D]/80 to-transparent" />
              </>
            ) : (
              <div className="absolute inset-0 flex flex-col items-center justify-center">
                <div className="text-center text-gray-500">
                  <Camera className="w-12 h-12 mx-auto mb-3 opacity-30" />
                  <p className="text-sm">Add a cover photo</p>
                  <p className="text-xs text-gray-600 mt-1">1200x400 recommended</p>
                </div>
              </div>
            )}

            {/* Cover Photo Upload - Enhanced Button */}
            {coverPhotoUploading && (
              <div className="absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-md">
                <div className="text-center">
                  <Loader2 className="h-12 w-12 animate-spin text-cyan-400 mx-auto mb-3" />
                  <p className="text-white text-sm font-medium">Uploading cover photo...</p>
                </div>
              </div>
            )}

            <Label htmlFor="cover-photo-upload" className="absolute top-4 right-4 cursor-pointer group/cover">
              <div className="bg-black/60 hover:bg-black/80 backdrop-blur-md text-white text-sm px-4 py-2 rounded-lg border border-white/20 hover:border-white/40 flex items-center gap-2 transition-all duration-300 hover:scale-105 shadow-lg">
                {coverPhotoUploading ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  <Camera className="h-4 w-4" />
                )}
                <span className="font-medium">{coverPhotoUrl ? 'Change Cover' : 'Add Cover'}</span>
              </div>
              <input
                id="cover-photo-upload"
                type="file"
                accept="image/*"
                onChange={handleCoverPhotoUpload}
                className="sr-only"
                disabled={coverPhotoUploading}
              />
            </Label>
          </div>

          {/* Profile Section */}
          <div className="relative px-8 pb-8">
            {/* Profile Photo - Enhanced with Glow */}
            <div className="relative -mt-20 mb-6">
              <div className="relative w-40 h-40 group/avatar">
                {/* Glow effect */}
                <div className="absolute -inset-2 bg-gradient-to-r from-cyan-500/30 to-purple-500/30 rounded-full blur-xl opacity-0 group-hover/avatar:opacity-100 transition-opacity duration-500" />

                <div className="relative w-40 h-40 rounded-full ring-4 ring-[#0B0B0D] overflow-hidden">
                  {photoUploading ? (
                    <div className="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-800 to-gray-900 backdrop-blur-sm">
                      <Loader2 className="h-10 w-10 animate-spin text-cyan-400" />
                    </div>
                  ) : avatarUrl ? (
                    <Image
                      src={avatarUrl}
                      alt="Profile Photo"
                      fill
                      className="object-cover"
                      unoptimized
                      onError={() => setAvatarUrl(null)}
                    />
                  ) : (
                    <div className="w-full h-full rounded-full bg-gradient-to-br from-gray-800 via-gray-900 to-gray-950 flex items-center justify-center border-2 border-white/10">
                      <User className="w-20 h-20 text-gray-600" />
                    </div>
                  )}
                </div>

                {/* Upload Button - Floating Badge */}
                <Label htmlFor="profile-photo-upload" className="absolute bottom-1 right-1 cursor-pointer">
                  <div className="rounded-full w-12 h-12 bg-gradient-to-br from-cyan-500 to-purple-600 hover:from-cyan-600 hover:to-purple-700 shadow-lg shadow-cyan-500/50 flex items-center justify-center transition-all duration-300 hover:scale-110 border-2 border-[#0B0B0D]">
                    {photoUploading ? (
                      <Loader2 className="h-5 w-5 animate-spin text-white" />
                    ) : (
                      <Camera className="h-5 w-5 text-white" />
                    )}
                  </div>
                  <input
                    id="profile-photo-upload"
                    type="file"
                    accept="image/*"
                    onChange={handlePhotoUpload}
                    className="sr-only"
                    disabled={photoUploading}
                  />
                </Label>
              </div>
            </div>

            {/* Name and Details */}
            <div className="space-y-2">
              <h2 className="text-3xl font-bold text-white">
                {profile?.first_name && profile?.last_name
                  ? `${profile.first_name} ${profile.last_name}`
                  : 'Your Name'}
              </h2>

              {formData.headline && (
                <p className="text-lg text-gray-300 font-medium">{formData.headline}</p>
              )}

              <div className="flex flex-wrap items-center gap-3 text-sm">
                {formData.username && (
                  <span className="text-gray-400 flex items-center gap-1">
                    <User className="w-4 h-4" />
                    @{formData.username}
                  </span>
                )}

                {formData.position && (
                  <span className="text-gray-400 flex items-center gap-1">
                    <Briefcase className="w-4 h-4" />
                    {formData.position}
                  </span>
                )}
              </div>
            </div>

            {/* Error Messages */}
            {(photoError || coverPhotoError) && (
              <div className="mt-4 space-y-2">
                {photoError && (
                  <p className="text-sm text-red-400 flex items-center gap-2 bg-red-500/10 border border-red-500/20 rounded-lg px-3 py-2">
                    <X className="w-4 h-4" />
                    {photoError}
                  </p>
                )}
                {coverPhotoError && (
                  <p className="text-sm text-red-400 flex items-center gap-2 bg-red-500/10 border border-red-500/20 rounded-lg px-3 py-2">
                    <X className="w-4 h-4" />
                    {coverPhotoError}
                  </p>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Basic Information Card - Polished */}
        <div className="relative rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8 transition-all duration-300 hover:border-white/20 hover:bg-white/[0.07] group">
          {/* Gradient Accent */}
          <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-cyan-500 to-purple-600 rounded-l-2xl opacity-50 group-hover:opacity-100 transition-opacity" />

          <div className="flex items-center gap-3 mb-8">
            <div className="p-3 rounded-xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 border border-cyan-500/30">
              <User className="w-6 h-6 text-cyan-400" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-white">Basic Information</h3>
              <p className="text-sm text-gray-400">Your personal details and contact information</p>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Username with Real-time Validation */}
            <div>
              <Label htmlFor="username" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Username <span className="text-red-400">*</span>
              </Label>
              <div className="relative">
                <User className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500" />
                <Input
                  id="username"
                  value={formData.username}
                  onChange={(e) => handleInputChange('username', e.target.value)}
                  placeholder="johndoe"
                  className={cn(
                    inputClass,
                    "pl-10 pr-10",
                    usernameAvailable === false && "border-red-500/50",
                    usernameAvailable === true && "border-green-500/50"
                  )}
                  maxLength={20}
                  disabled={shouldDisableFields}
                />
                {usernameChecking && (
                  <Loader2 className="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-cyan-400 animate-spin" />
                )}
                {usernameAvailable === true && !usernameChecking && (
                  <CheckCircle className="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-green-500" />
                )}
                {usernameAvailable === false && !usernameChecking && (
                  <X className="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-red-500" />
                )}
              </div>
              <div className="flex items-center justify-between mt-1.5">
                <span className="text-xs text-gray-500">{formData.username.length}/20</span>
                {usernameAvailable === true && (
                  <span className="text-xs text-green-400 flex items-center gap-1">
                    <CheckCircle className="w-3 h-3" />
                    Available
                  </span>
                )}
                {usernameAvailable === false && (
                  <span className="text-xs text-red-400 flex items-center gap-1">
                    <X className="w-3 h-3" />
                    Taken
                  </span>
                )}
              </div>
            </div>

            {/* Headline */}
            <div>
              <Label htmlFor="headline" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Professional Headline
              </Label>
              <Input
                id="headline"
                value={formData.headline}
                onChange={(e) => handleInputChange('headline', e.target.value)}
                placeholder="e.g., Customer Service Representative"
                className={inputClass}
                maxLength={100}
                disabled={shouldDisableFields}
              />
              <p className="text-xs text-gray-500 mt-1.5">{formData.headline.length}/100</p>
            </div>

            {/* Phone */}
            <div>
              <Label htmlFor="phone" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Phone Number <span className="text-red-400">*</span>
              </Label>
              <div className="relative">
                <Phone className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500" />
                <Input
                  id="phone"
                  type="tel"
                  value={formData.phone}
                  onChange={(e) => handleInputChange('phone', e.target.value)}
                  placeholder="+63 912 345 6789"
                  className={cn(inputClass, "pl-10")}
                  disabled={shouldDisableFields}
                />
              </div>
            </div>

            {/* Birthday with Age Display */}
            <div>
              <Label className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Birthday <span className="text-red-400">*</span>
              </Label>
              <div className="grid grid-cols-3 gap-3">
                {/* Month */}
                <Select
                  value={formData.birthday ? formData.birthday.split('-')[1] : ''}
                  onValueChange={(month) => {
                    const parts = formData.birthday ? formData.birthday.split('-') : []
                    const year = parts[0] || String(new Date().getFullYear() - 25) // Default to 25 years ago
                    const day = parts[2] || '15' // Default to mid-month
                    handleInputChange('birthday', `${year}-${month}-${day}`)
                  }}
                  disabled={shouldDisableFields}
                >
                  <SelectTrigger className={inputClass}>
                    <SelectValue placeholder="Month" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="01">January</SelectItem>
                    <SelectItem value="02">February</SelectItem>
                    <SelectItem value="03">March</SelectItem>
                    <SelectItem value="04">April</SelectItem>
                    <SelectItem value="05">May</SelectItem>
                    <SelectItem value="06">June</SelectItem>
                    <SelectItem value="07">July</SelectItem>
                    <SelectItem value="08">August</SelectItem>
                    <SelectItem value="09">September</SelectItem>
                    <SelectItem value="10">October</SelectItem>
                    <SelectItem value="11">November</SelectItem>
                    <SelectItem value="12">December</SelectItem>
                  </SelectContent>
                </Select>

                {/* Day */}
                <Select
                  value={formData.birthday ? formData.birthday.split('-')[2] : ''}
                  onValueChange={(day) => {
                    const parts = formData.birthday ? formData.birthday.split('-') : []
                    const year = parts[0] || String(new Date().getFullYear() - 25) // Default to 25 years ago
                    const month = parts[1] || '06' // Default to June
                    handleInputChange('birthday', `${year}-${month}-${day}`)
                  }}
                  disabled={shouldDisableFields}
                >
                  <SelectTrigger className={inputClass}>
                    <SelectValue placeholder="Day" />
                  </SelectTrigger>
                  <SelectContent>
                    {Array.from({ length: 31 }, (_, i) => i + 1).map((day) => (
                      <SelectItem key={day} value={day.toString().padStart(2, '0')}>
                        {day}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>

                {/* Year */}
                <Select
                  value={formData.birthday ? formData.birthday.split('-')[0] : ''}
                  onValueChange={(year) => {
                    const parts = formData.birthday ? formData.birthday.split('-') : []
                    const month = parts[1] || '06' // Default to June
                    const day = parts[2] || '15' // Default to mid-month
                    handleInputChange('birthday', `${year}-${month}-${day}`)
                  }}
                  disabled={shouldDisableFields}
                >
                  <SelectTrigger className={inputClass}>
                    <SelectValue placeholder="Year" />
                  </SelectTrigger>
                  <SelectContent className="max-h-[200px]">
                    {Array.from({ length: 100 }, (_, i) => new Date().getFullYear() - 18 - i).map((year) => (
                      <SelectItem key={year} value={year.toString()}>
                        {year}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              {age !== null && (
                <p className="text-xs text-cyan-400 mt-1.5 font-medium">Age: {age} years old</p>
              )}
              {!formData.birthday && (
                <p className="text-xs text-gray-500 mt-1.5">Much easier than scrolling through years!</p>
              )}
            </div>

            {/* Gender */}
            <div>
              <Label htmlFor="gender" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Gender <span className="text-red-400">*</span>
              </Label>
              <Select
                value={formData.gender}
                onValueChange={(value) => handleInputChange('gender', value)}
                disabled={shouldDisableFields}
              >
                <SelectTrigger className={inputClass}>
                  <SelectValue placeholder="Select gender" />
                </SelectTrigger>
                <SelectContent className="bg-[#1a1a1d] border-white/10 text-white">
                  <SelectItem value="male">Male</SelectItem>
                  <SelectItem value="female">Female</SelectItem>
                  <SelectItem value="non_binary">Non-binary</SelectItem>
                  <SelectItem value="prefer_not_to_say">Prefer not to say</SelectItem>
                  <SelectItem value="other">Other</SelectItem>
                </SelectContent>
              </Select>
              {formData.gender === 'other' && (
                <Input
                  className={cn(inputClass, "mt-2")}
                  placeholder="Please specify"
                  value={formData.gender_custom}
                  onChange={(e) => handleInputChange('gender_custom', e.target.value)}
                  disabled={shouldDisableFields}
                />
              )}
            </div>

            {/* Position */}
            <div>
              <Label htmlFor="position" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Current/Desired Position
              </Label>
              <div className="relative">
                <Briefcase className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500" />
                <Input
                  id="position"
                  value={formData.position}
                  onChange={(e) => handleInputChange('position', e.target.value)}
                  placeholder="e.g., Customer Service Representative"
                  className={cn(inputClass, "pl-10")}
                  disabled={shouldDisableFields}
                />
              </div>
            </div>

            {/* Bio - Full Width */}
            <div className="md:col-span-2">
              <Label htmlFor="bio" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Bio <span className="text-red-400">*</span>
              </Label>
              <Textarea
                id="bio"
                value={formData.bio}
                onChange={(e) => handleInputChange('bio', e.target.value)}
                rows={4}
                placeholder="Tell us about your experience, skills, and career goals..."
                className={inputClass}
                maxLength={500}
                disabled={shouldDisableFields}
              />
              <p className="text-xs text-gray-500 mt-1.5">{formData.bio.length}/500 characters</p>
            </div>
          </div>
        </div>

        {/* Location Card with AI Badge */}
        <div className="relative rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8 transition-all duration-300 hover:border-white/20 hover:bg-white/[0.07] group">
          <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-purple-500 to-pink-600 rounded-l-2xl opacity-50 group-hover:opacity-100 transition-opacity" />

          <div className="flex items-center justify-between mb-8">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30">
                <MapPin className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">Location</h3>
                <p className="text-sm text-gray-400">Where are you based?</p>
              </div>
            </div>

            {/* AI Powered Badge */}
            <div className="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-500/30">
              <Sparkles className="w-4 h-4 text-cyan-400" />
              <span className="text-xs font-semibold text-cyan-400">AI Powered</span>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Full Address with AI Parser */}
            <div className="md:col-span-2">
              <Label htmlFor="location" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Full Address <span className="text-red-400">*</span>
              </Label>
              <div className="relative">
                <MapPin className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500 z-10" />
                <Input
                  id="location"
                  value={formData.location}
                  onChange={(e) => handleInputChange('location', e.target.value)}
                  onBlur={(e) => parseLocation(e.target.value)}
                  placeholder="e.g., Angeles City, Pampanga, Philippines"
                  className={cn(inputClass, "pl-10 pr-10")}
                  disabled={shouldDisableFields || locationParsing}
                />
                {locationParsing && (
                  <div className="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                    <Loader2 className="w-4 h-4 text-cyan-400 animate-spin" />
                  </div>
                )}
              </div>
              <p className="text-xs mt-1.5 flex items-center gap-1.5">
                {locationParsing ? (
                  <>
                    <Sparkles className="w-3 h-3 text-cyan-400 animate-pulse" />
                    <span className="text-cyan-400 font-medium">AI parsing location...</span>
                  </>
                ) : (
                  <>
                    <Sparkles className="w-3 h-3 text-gray-500" />
                    <span className="text-gray-500">AI will auto-detect city, province, and region</span>
                  </>
                )}
              </p>
            </div>

            {/* Barangay */}
            <div>
              <Label htmlFor="location_barangay" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Barangay
              </Label>
              <Input
                id="location_barangay"
                value={formData.location_barangay}
                onChange={(e) => handleInputChange('location_barangay', e.target.value)}
                placeholder="e.g., Kapaya"
                className={inputClass}
                disabled={shouldDisableFields}
              />
            </div>

            {/* Region */}
            <div>
              <Label htmlFor="location_region" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Region
              </Label>
              <Input
                id="location_region"
                value={formData.location_region}
                onChange={(e) => handleInputChange('location_region', e.target.value)}
                placeholder="e.g., Region 3 - Central Luzon"
                className={inputClass}
                disabled={shouldDisableFields}
              />
            </div>
          </div>
        </div>

        {/* Work Preferences Card */}
        <div className="relative rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8 transition-all duration-300 hover:border-white/20 hover:bg-white/[0.07] group">
          <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-cyan-500 to-blue-600 rounded-l-2xl opacity-50 group-hover:opacity-100 transition-opacity" />

          <div className="flex items-center gap-3 mb-8">
            <div className="p-3 rounded-xl bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border border-cyan-500/30">
              <Briefcase className="w-6 h-6 text-cyan-400" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-white">Work Preferences</h3>
              <p className="text-sm text-gray-400">Your employment situation and job preferences</p>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Work Status */}
            <div>
              <Label htmlFor="work_status" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Work Status <span className="text-red-400">*</span>
              </Label>
              <Select
                value={formData.work_status}
                onValueChange={(value) => handleInputChange('work_status', value)}
                disabled={shouldDisableFields}
              >
                <SelectTrigger className={inputClass}>
                  <SelectValue placeholder="Select work status" />
                </SelectTrigger>
                <SelectContent className="bg-[#1a1a1d] border-white/10 text-white">
                  {WORK_STATUS_OPTIONS.map((option) => (
                    <SelectItem key={option.value} value={option.value}>
                      {option.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Preferred Shift */}
            <div>
              <Label htmlFor="preferred_shift" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Preferred Shift <span className="text-red-400">*</span>
              </Label>
              <Select
                value={formData.preferred_shift}
                onValueChange={(value) => handleInputChange('preferred_shift', value)}
                disabled={shouldDisableFields}
              >
                <SelectTrigger className={inputClass}>
                  <SelectValue placeholder="Select shift" />
                </SelectTrigger>
                <SelectContent className="bg-[#1a1a1d] border-white/10 text-white">
                  {SHIFT_OPTIONS.map((option) => (
                    <SelectItem key={option.value} value={option.value}>
                      {option.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Work Setup */}
            <div>
              <Label htmlFor="preferred_work_setup" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Preferred Work Setup <span className="text-red-400">*</span>
              </Label>
              <Select
                value={formData.preferred_work_setup}
                onValueChange={(value) => handleInputChange('preferred_work_setup', value)}
                disabled={shouldDisableFields}
              >
                <SelectTrigger className={inputClass}>
                  <SelectValue placeholder="Select work setup" />
                </SelectTrigger>
                <SelectContent className="bg-[#1a1a1d] border-white/10 text-white">
                  {WORK_SETUP_OPTIONS.map((option) => (
                    <SelectItem key={option.value} value={option.value}>
                      {option.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Current Mood */}
            <div>
              <Label htmlFor="current_mood" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Current Mood <span className="text-xs text-gray-500">(Optional)</span>
              </Label>
              <Select
                value={formData.current_mood}
                onValueChange={(value) => handleInputChange('current_mood', value)}
                disabled={shouldDisableFields}
              >
                <SelectTrigger className={inputClass}>
                  <SelectValue placeholder="Select mood" />
                </SelectTrigger>
                <SelectContent className="bg-[#1a1a1d] border-white/10 text-white">
                  <SelectItem value="prefer_not_to_say">Prefer not to say</SelectItem>
                  {MOOD_OPTIONS.map((option) => (
                    <SelectItem key={option.value} value={option.value}>
                      {option.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Expected Salary Range */}
            <div className="md:col-span-2">
              <Label className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Expected Salary Range <span className="text-red-400">*</span>
              </Label>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Input
                    id="expected_salary_min"
                    type="number"
                    value={formData.expected_salary_min}
                    onChange={(e) => handleInputChange('expected_salary_min', e.target.value)}
                    placeholder="Min (e.g., 25000)"
                    className={inputClass}
                    disabled={shouldDisableFields}
                  />
                  <p className="text-xs text-gray-500 mt-1">Minimum</p>
                </div>
                <div>
                  <Input
                    id="expected_salary_max"
                    type="number"
                    value={formData.expected_salary_max}
                    onChange={(e) => handleInputChange('expected_salary_max', e.target.value)}
                    placeholder="Max (e.g., 35000)"
                    className={inputClass}
                    disabled={shouldDisableFields}
                  />
                  <p className="text-xs text-gray-500 mt-1">Maximum</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Social Links Card */}
        <div className="relative rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8 transition-all duration-300 hover:border-white/20 hover:bg-white/[0.07] group">
          <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-purple-500 to-pink-600 rounded-l-2xl opacity-50 group-hover:opacity-100 transition-opacity" />

          <div className="flex items-center gap-3 mb-8">
            <div className="p-3 rounded-xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30">
              <FileText className="w-6 h-6 text-purple-400" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-white">Social Links</h3>
              <p className="text-sm text-gray-400">Connect your professional profiles (optional)</p>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Website */}
            <div>
              <Label htmlFor="website" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Website
              </Label>
              <Input
                id="website"
                type="url"
                value={formData.website}
                onChange={(e) => handleInputChange('website', e.target.value)}
                placeholder="https://yourwebsite.com"
                className={inputClass}
                disabled={shouldDisableFields}
              />
            </div>

            {/* LinkedIn */}
            <div>
              <Label htmlFor="linkedin" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                LinkedIn
              </Label>
              <Input
                id="linkedin"
                type="url"
                value={formData.linkedin}
                onChange={(e) => handleInputChange('linkedin', e.target.value)}
                placeholder="https://linkedin.com/in/username"
                className={inputClass}
                disabled={shouldDisableFields}
              />
            </div>

            {/* GitHub */}
            <div>
              <Label htmlFor="github" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                GitHub
              </Label>
              <Input
                id="github"
                type="url"
                value={formData.github}
                onChange={(e) => handleInputChange('github', e.target.value)}
                placeholder="https://github.com/username"
                className={inputClass}
                disabled={shouldDisableFields}
              />
            </div>

            {/* Portfolio */}
            <div>
              <Label htmlFor="portfolio" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Portfolio
              </Label>
              <Input
                id="portfolio"
                type="url"
                value={formData.portfolio}
                onChange={(e) => handleInputChange('portfolio', e.target.value)}
                placeholder="https://portfolio.com"
                className={inputClass}
                disabled={shouldDisableFields}
              />
            </div>

            {/* Twitter */}
            <div>
              <Label htmlFor="twitter" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Twitter
              </Label>
              <Input
                id="twitter"
                type="url"
                value={formData.twitter}
                onChange={(e) => handleInputChange('twitter', e.target.value)}
                placeholder="https://twitter.com/username"
                className={inputClass}
                disabled={shouldDisableFields}
              />
            </div>

            {/* Facebook */}
            <div>
              <Label htmlFor="facebook" className={cn(labelClass, "mb-2 block text-sm font-medium")}>
                Facebook
              </Label>
              <Input
                id="facebook"
                type="url"
                value={formData.facebook}
                onChange={(e) => handleInputChange('facebook', e.target.value)}
                placeholder="https://facebook.com/username"
                className={inputClass}
                disabled={shouldDisableFields}
              />
            </div>
          </div>
        </div>

        {/* Sticky Save Button - Enhanced */}
        {isEditing && (
          <div className="sticky bottom-0 left-0 right-0 bg-gradient-to-t from-[#0B0B0D] via-[#0B0B0D]/98 to-transparent pt-8 pb-6 -mx-6 px-6 backdrop-blur-md border-t border-white/5">
            <div className="flex justify-between items-center max-w-7xl mx-auto">
              <p className="text-sm text-gray-400 hidden sm:block">
                Don't forget to save your changes
              </p>
              <div className="flex gap-3 ml-auto">
                <Button
                  onClick={handleCancel}
                  disabled={saving}
                  variant="outline"
                  className="border-white/10 text-gray-300 hover:bg-white/5 hover:border-white/20 transition-all"
                >
                  <X className="w-4 h-4 mr-2" />
                  Cancel
                </Button>
                <Button
                  onClick={handleSave}
                  disabled={saving}
                  className="bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-600 hover:to-purple-700 text-white shadow-lg shadow-cyan-500/30 transition-all duration-300 hover:scale-105"
                >
                  {saving ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Saving...
                    </>
                  ) : (
                    <>
                      <CheckCircle className="w-4 h-4 mr-2" />
                      Save Changes
                    </>
                  )}
                </Button>
              </div>
            </div>
          </div>
        )}
      </div>
    </TooltipProvider>
  )
}
